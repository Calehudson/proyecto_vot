_format_version: "3.0"

plugins:
  # 1️⃣ Este plugin expone /status con HTTP 200
  - name: status
    enabled: true
    protocols:
      - http
      - https
    config:
      status_path: /status

  # 2️⃣ Tu plugin file-log existente
  - name: file-log
    enabled: true
    protocols:
      - grpc
      - grpcs
      - http
      - https
    config:
      path: /var/log/kong/all_requests.log
      reopen: false
      custom_fields_by_lua: null

consumers:
  - username: anonymous_user
  - username: usuario_externo
    keyauth_credentials:
      - key: 1JRy74hZjAETqJeWTm569FQvtDvdmZr1
      - key: nC8l0eyQy7H9Hn0hC1xYALFMOX92OQ0K
  - username: usuario_frontend
    jwt_secrets:
      - algorithm: HS256
        key: 8f01T8gMPgvJP8lf5ZVP738wbZZPzCZT
        secret: LFQTyqqHAyJEGTSqwfUjDua7Az8d9Bbu

plugins:
  - name: file-log
    enabled: true
    protocols:
      - grpc
      - grpcs
      - http
      - https
    config:
      path: /var/log/kong/all_requests.log
      reopen: false
      custom_fields_by_lua: null

services:
  - name: ms-logeo
    # Upstream is the same ALB that fronts the services
    host: vot-dev-alb-9315723.us-east-1.elb.amazonaws.com
    port: 80
    protocol: http
    connect_timeout: 60000
    read_timeout:    60000
    write_timeout:   60000
    retries: 5
    plugins:
      - name: cors
        enabled: true
        protocols:
          - http
          - https
        config:
          origins:
            - http://vot-dev-alb-9315723.us-east-1.elb.amazonaws.com
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
            - Origin
          exposed_headers:
            - X-Custom-Header
          credentials: true
          max_age: 3600
          preflight_continue: false
    routes:
      - id: logeo-route
        protocols:
          - http
          - https
        paths:
          - /api/logeo
          - /api/logeo/*
        strip_path: true
        preserve_host: false
        path_handling: v0

  - name: ms-participantes
    host: vot-dev-alb-9315723.us-east-1.elb.amazonaws.com
    port: 80
    protocol: http
    connect_timeout: 60000
    read_timeout:    60000
    write_timeout:   60000
    retries: 5
    plugins:
      - name: cors
        enabled: true
        protocols:
          - http
          - https
        config:
          origins:
            - http://vot-dev-alb-9315723.us-east-1.elb.amazonaws.com
          methods:
            - GET
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
            - Origin
          exposed_headers:
            - X-Custom-Header
          credentials: true
          max_age: 3600
          preflight_continue: false
    routes:
      - id: participantes-route
        protocols:
          - http
          - https
        paths:
          - /api/participantes
          - /api/participantes/*
        strip_path: true
        preserve_host: false
        path_handling: v0

  - name: ms-votaciones
    host: vot-dev-alb-9315723.us-east-1.elb.amazonaws.com
    port: 80
    protocol: http
    connect_timeout: 60000
    read_timeout:    60000
    write_timeout:   60000
    retries: 5
    plugins:
      - name: cors
        enabled: true
        protocols:
          - http
          - https
        config:
          origins:
            - http://vot-dev-alb-9315723.us-east-1.elb.amazonaws.com
          methods:
            - GET
            - POST
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
            - Origin
          exposed_headers:
            - X-Custom-Header
          credentials: true
          max_age: 3600
          preflight_continue: false
    routes:
      - id: votaciones-list-route
        protocols:
          - http
          - https
        paths:
          - /api/votaciones/listavotaciones
        strip_path: true
        preserve_host: false
        path_handling: v0
        plugins:
          - name: jwt
            enabled: true
            config:
              anonymous: e12b4338-3a5d-4378-a73a-5089142de66c
              uri_param_names:
                - jwt
              secret_is_base64: false
          - name: key-auth
            enabled: true
            config:
              anonymous: e12b4338-3a5d-4378-a73a-5089142de66c
              key_names:
                - apikey
          - name: pre-function
            enabled: true
            config:
              access:
                - |
                  local method = kong.request.get_method()
                  if method == "OPTIONS" then return end
                  local h = kong.request.get_headers()
                  local has_jwt = h["authorization"] and h["authorization"]:find("^Bearer%s+") ~= nil
                  local args = kong.request.get_query()
                  local has_key = args["apikey"] ~= nil
                  if not has_jwt and not has_key then
                    return kong.response.exit(401, { message = "Unauthorized: se requiere JWT o API-Key" })
                  end
      - id: votaciones-default-route
        protocols:
          - http
          - https
        paths:
          - /api/votaciones
          - /api/votaciones/*
        strip_path: true
        preserve_host: false
        path_handling: v0
