_format_version: "3.0"

consumers:
  - username: anonymous_user
  - username: usuario_externo
    keyauth_credentials:
      - key: 1JRy74hZjAETqJeWTm569FQvtDvdmZr1
      - key: nC8l0eyQy7H9Hn0hC1xYALFMOX92OQ0K
  - username: usuario_frontend
    jwt_secrets:
      - algorithm: HS256
        key: 8f01T8gMPgvJP8lf5ZVP738wbZZPzCZT
        secret: LFQTyqqHAyJEGTSqwfUjDua7Az8d9Bbu

plugins:
  - name: file-log
    enabled: true
    protocols:
      - grpc
      - grpcs
      - http
      - https
    config:
      path: /var/log/kong/all_requests.log
      reopen: false
      custom_fields_by_lua: null

services:
  - name: ms-logeo
    host: ms-logeo.vot.local
    port: 80
    protocol: http
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000
    retries: 5
    plugins:
      - name: cors
        enabled: true
        protocols:
          - grpc
          - grpcs
          - http
          - https
        config:
          origins:
            - http://vot-dev-alb-9315723.us-east-1.elb.amazonaws.com
          methods:
            - GET
            - HEAD
            - PUT
            - PATCH
            - POST
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
            - Origin
          exposed_headers:
            - X-Custom-Header
          credentials: true
          max_age: 3600
          preflight_continue: false
    routes:
      - id: 4e1d4b8c-fea2-4858-83d9-cd53249ce7cc
        protocols:
          - http
          - https
        paths:
          - "/api/logeo"
          - "/api/logeo/*"
        strip_path: true
        preserve_host: false
        path_handling: v0
        https_redirect_status_code: 426

  - name: ms-participantes
    host: ms-participantes.vot.local
    port: 80
    protocol: http
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000
    retries: 5
    plugins:
      - name: cors
        enabled: true
        protocols:
          - grpc
          - grpcs
          - http
          - https
        config:
          origins:
            - http://vot-dev-alb-9315723.us-east-1.elb.amazonaws.com
          methods:
            - GET
            - HEAD
            - PUT
            - PATCH
            - POST
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
            - Origin
          exposed_headers:
            - X-Custom-Header
          credentials: true
          max_age: 3600
          preflight_continue: false
    routes:
      - id: c9115216-f018-44fe-8caf-01eb9087b329
        protocols:
          - http
          - https
        paths:
          - "/api/participantes"
          - "/api/participantes/*"
        strip_path: true
        preserve_host: false
        path_handling: v0
        https_redirect_status_code: 426

  - name: ms-votaciones
    host: ms-votaciones.vot.local
    port: 80
    protocol: http
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000
    retries: 5
    plugins:
      - name: cors
        enabled: true
        protocols:
          - grpc
          - grpcs
          - http
          - https
        config:
          origins:
            - http://vot-dev-alb-9315723.us-east-1.elb.amazonaws.com
          methods:
            - GET
            - HEAD
            - PUT
            - PATCH
            - POST
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
            - Origin
          exposed_headers:
            - X-Custom-Header
          credentials: true
          max_age: 3600
          preflight_continue: false
    routes:
      # Ruta protegida con JWT o API-Key
      - id: f1c3b406-8343-4e70-85a4-6a21de8fbfc9
        protocols:
          - http
          - https
        paths:
          - "/api/votaciones/listavotaciones"
        strip_path: true
        preserve_host: false
        path_handling: v0
        https_redirect_status_code: 426
        plugins:
          - name: jwt
            enabled: true
            protocols:
              - grpc
              - grpcs
              - http
              - https
            config:
              anonymous: e12b4338-3a5d-4378-a73a-5089142de66c
              uri_param_names:
                - jwt
              secret_is_base64: false
              maximum_expiration: 0
          - name: key-auth
            enabled: true
            protocols:
              - grpc
              - grpcs
              - http
              - https
            config:
              anonymous: e12b4338-3a5d-4378-a73a-5089142de66c
              key_names:
                - apikey
              hide_credentials: false
              key_in_header: true
              key_in_query: true
              run_on_preflight: true
          - name: pre-function
            enabled: true
            protocols:
              - grpc
              - grpcs
              - http
              - https
            config:
              access:
                - |
                  local method = kong.request.get_method()
                  if method == "OPTIONS" then return end
                  local h = kong.request.get_headers()
                  local has_jwt = h["authorization"] and h["authorization"]:find("^Bearer%s+") ~= nil
                  local args = kong.request.get_query()
                  local has_key = args["apikey"] ~= nil
                  if not has_jwt and not has_key then
                    return kong.response.exit(401, { message = "Unauthorized: se requiere JWT o API-Key" })
                  end
      # Rutas públicas para todos los demás endpoints
      - id: 54306aff-483b-4c5d-af78-10e9878b8366
        protocols:
          - http
          - https
        paths:
          - "/api/votaciones"
          - "/api/votaciones/*"
        strip_path: true
        preserve_host: false
        path_handling: v0
        https_redirect_status_code: 426
